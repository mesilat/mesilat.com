<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Using Blueprint Validation and Confluence Fields Together - Mesilat Limited Documentation</title>

    
    <link rel="stylesheet" href="assets/css/expand-macro.css">

            <meta name="scroll-content-language-key" content="">
    
    <meta name="description" content="">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=2.0, user-scalable=yes">

<script type="text/javascript" src="assets/js/jquery.min.js"></script>
<script type="text/javascript" src="assets/js/jquery.scrollTo.min.js"></script>


<script type="text/javascript" src="assets/js/translate.js"></script>


<script type="text/javascript" src="assets/js/scroll-tree.js"></script>

<script type="text/javascript" src="assets/js/theme.main.js"></script>

    <script type="text/javascript" src="assets/js/iframeResizer.min.js"></script>

<link rel="stylesheet" href="assets/css/content-style.css">
    <link rel="stylesheet" href="assets/css/search.css">

<link rel="stylesheet" href="assets/css/theme.main.css">
<link rel="stylesheet" href="assets/css/theme.colors.css">

            <!-- ES5 support for older browsers, needed by lunr -->
        <script src="js/augment.js"></script>
        <script id="worker" type="javascript/worker">

        startIndex = function() {
            idx = lunr.Index.load(lunrIndex);
            idx.pipeline.remove(lunr.stopWordFilter);
            postMessage({type: "setup-complete"});
        }

        onmessage = function (event) {
            var message = event.data;

            if ((message.type === 'setup') && message.baseUrl) {
                var url = message.baseUrl;
                importScripts(url + 'js/lunr.js');
                importScripts(url + 'js/lunr-extras.js');
                importScripts(url + 'js/lunr-index.js');
                importScripts(url + 'js/lunr-data.js');
                startIndex();
            }

            if (idx && (message.type === 'search-request') && message.query) {
                var searchWord = message.query;
                var results = idx.search(searchWord).map(function (result) {
                    return lunrData.filter(function (d) {
                        return d.id === parseInt(result.ref, 10)
                    })[0]
                });
                postMessage({type: 'search-results', results: results, query: searchWord, queryId: message.queryId});
            }
        }

    </script>
    </head>

<body pageid="44696055">

<div id="ht-loader">
    <noscript>
        <p style="width: 100%; text-align:center; position: absolute; margin-top: 200px;">This content cannot be displayed without JavaScript.<br>Please enable JavaScript and reload the page.</p>
    </noscript>
</div>

<div>
   	<header id="ht-headerbar">
    <div class="ht-headerbar-left">
        <a href="" id="ht-menu-toggle" class="sp-aui-icon-small sp-aui-iconfont-appswitcher"></a>
    </div>
    <div class="ht-headerbar-right">
            <div class="sp-aui-icon-small ht-search-index-loader ht-header-icon"></div>

        <div id="ht-search">
            <div class="ht-search-input" style="display: none;">
              	<a href="#" class="sp-aui-icon-small sp-aui-iconfont-remove ht-search-clear"></a>

                <form action="#" method="GET" id="search">
                    <input class="search-input" type="text" placeholder="Search" tabindex="-1" autocomplete="off" name="q" value="">
                    <input type="hidden" name="max" value="15" />
                    <input type="submit" style="display:none" tabindex="-4"/>
                </form>

                <a href="#" id="ht-search-button" class="ht-header-icon ht-header-icon-svg">
                                        <svg width="40px" height="40px" viewBox="0 0 40 40" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                        <g>
                            <path d="M29.572,28.802 L28.801,29.571 C28.515,29.857 28.187,30 27.816,30 C27.445,30 27.116,29.857 26.831,29.571 L21.392,24.134 C20.193,24.762 18.908,25.076 17.538,25.076 C15.396,25.076 13.605,24.348 12.163,22.892 C10.721,21.436 10,19.651 10,17.538 C10,15.397 10.721,13.605 12.163,12.163 C13.605,10.721 15.396,10 17.538,10 C19.651,10 21.434,10.721 22.89,12.163 C24.347,13.605 25.075,15.397 25.075,17.538 C25.075,18.937 24.761,20.222 24.132,21.393 L29.572,26.832 C29.857,27.118 30,27.446 30,27.817 C30,28.188 29.857,28.517 29.572,28.802 L29.572,28.802 Z M13.662,21.414 C14.732,22.485 16.024,23.02 17.538,23.02 C19.051,23.02 20.343,22.485 21.413,21.414 C22.484,20.344 23.019,19.052 23.019,17.538 C23.019,16.025 22.484,14.733 21.413,13.662 C20.343,12.592 19.051,12.056 17.538,12.056 C16.024,12.056 14.732,12.592 13.662,13.662 C12.591,14.733 12.056,16.025 12.056,17.538 C12.056,19.052 12.591,20.344 13.662,21.414 L13.662,21.414 Z"></path>
                        </g>
                    </svg>
              	</a>

                <div class="ht-search-dropdown ht-dropdown">
                    <ul></ul>
                </div>
            </div>
        </div>
    </div>
    </header>   	<aside id="ht-sidebar">
    <div class="ht-sidebar-content">
        <div class="ht-sidebar-content-scroll-container">
            <header class="ht-sidebar-header">
                <h1 class="ht-logo">
                    <span class="ht-logo-label">PUB</span>
                    <img class="space-logo" src="PUB.png" />
                </h1>
                <a href="44696055.html" class="ht-space-link">
                    <h2>Mesilat Limited Documentation</h2>
                </a>
            </header>
                            <iframe id="ht-nav" src="toc.html?pageId=51151335"></iframe>
                <script>
                    $('iframe#ht-nav').iFrameResize(
                            { 'log': true, 'autoResize': true, 'heightCalculationMethod': 'lowestElement', 'checkOrigin': false });
                </script>
                    </div>
    </div>

</aside></div>

<div id="ht-wrap-container">

            
    <div id="ht-sidebar-dragbar">
    <div class="ht-sidebar-drag-handle">
        <span class="drag-handle-1"></span>
        <span class="drag-handle-2"></span>
        <span class="drag-handle-3"></span>
    </div>
</div>
    <article id="ht-content" class="ht-content">
        <header class="ht-content-header">
            <div id="ht-breadcrumb">
    <ul>
        <li><a href="44696055.html">Mesilat Limited Documentation</a></li>
                                                            </ul>
</div>            <h1 id="src-51151335"> <span>Using Blueprint Validation and Confluence Fields Together</span></h1>
        </header>

        <div id="main-content" class="wiki-content sp-grid-section" data-index-for-search="true">

<p   
><a   href="44696004.html">Confluence Fields plugin for Atlassian JIRA</a> provides reporting via builtin Mondrian server. All Confluence custom fields you define are reported in MS Excel pivot using XMLA datasource plugin as described in <a   href="https://slava.bvn.me/wiki/display/MES/Using+Mondrian+with+Confluence+Fields">Using Mondrian with Confluence Fields</a>.</p>
<p   
>However default XMLA schema is very basic: Confluence field-derived OLAP dimensions are flat, no hierarchies are defined. That makes sense as Confluence fields only keep Confluence page's <i class=" ">id</i> and <i class=" ">title</i>, no other information from Confluence is stored. But what if you need a more complex reporting? Suppose that you have a 'Clients' custom field that sources its values from a Client blueprint in your Confluence server. The blueprint has a field named 'Country' that you want to use to group your customers for JIRA reporting. Let's keep the blueprint very simple:</p>
<p   
><img  class="confluence-embedded-image image-center"                 style="display:block; margin-left: auto; margin-right: auto;"
     src="images/wiki/download/attachments/51151335/Screenshot_2020-12-22_at_12.37.29.png" alt="images/wiki/download/attachments/51151335/Screenshot_2020-12-22_at_12.37.29.png"   />
    <br/>To get the Country information in MS Excel pivot I do the following:</p>
<ul class=" "><li class=" "><p   
>Install the <a   href="44696031.html">Blueprint Validation</a> plugin for Confluence. The plugin is used to parse my Confluence pages to JSON and to check them against JSON schema to make sure that the data entered is valid</p>
</li><li class=" "><p   
>Develop and deploy a <a  class="external-link" href="https://github.com/mesilat/blueprint-validation-demo">custom Confluence server</a> plugin that publishes JSON data to a JIRA server</p>
</li><li class=" "><p   
>Develop and deploy a <a  class="external-link" href="https://github.com/mesilat/blueprint-validation-demo-companion">custom JIRA server</a> plugin that consumes the JSON data and saves it to the JIRA database</p>
</li><li class=" "><p   
>Develop a <a  class="external-link" href="https://mondrian.pentaho.com/documentation/schema.php">Mondrian schema</a> that defines OLAP dimensions with hierarchies that use the data saved</p>
</li></ul><p   
>As a result I get an Excel pivot that features the required data grouping:</p>
    <div class="section section-1" id="src-51151335_UsingBlueprintValidationandConfluenceFieldsTogether-ConfluencePart">
        <h1 class="heading "><span>Confluence Part</span></h1>
<p   
>In order to have my Confluence blueprint parsed and validated I have to follow some formatting rules as described in <a   href="44696032.html">Blueprint Validation Markup</a>. Take a look at an <a  class="external-link" href="https://github.com/mesilat/blueprint-validation-demo/blob/master/src/main/resources/xml/company.xml">example</a>:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                    <div class="title">company.xml</div>
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-title="company.xml" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">&lt;</code><code class="keyword">ac</code><code class="plain">:layout&gt;&lt;</code><code class="keyword">ac</code><code class="plain">:layout-section </code><code class="color1">ac:type</code><code class="plain">=</code><code class="string">"single"</code><code class="plain">&gt;</code></div>
<div class="line"><code class="plain">&lt;</code><code class="keyword">ac</code><code class="plain">:layout-cell&gt;</code></div>
<div class="line"><code class="plain">&lt;</code><code class="keyword">table</code><code class="plain"> </code><code class="color1">class</code><code class="plain">=</code><code class="string">"wrapped"</code><code class="plain">&gt;</code></div>
<div class="line"><code class="plain">&lt;</code><code class="keyword">colgroup</code><code class="plain">&gt; &lt;</code><code class="keyword">col</code><code class="plain">/&gt; &lt;</code><code class="keyword">col</code><code class="plain">/&gt; &lt;/</code><code class="keyword">colgroup</code><code class="plain">&gt;</code></div>
<div class="line"><code class="plain">&lt;</code><code class="keyword">tbody</code><code class="plain">&gt;</code></div>
<div class="line"><code class="plain">&lt;</code><code class="keyword">tr</code><code class="plain">&gt;</code></div>
<div class="line"><code class="plain">&lt;</code><code class="keyword">th</code><code class="plain">&gt;Account manager&lt;/</code><code class="keyword">th</code><code class="plain">&gt;</code></div>
<div class="line"><code class="plain">&lt;</code><code class="keyword">td</code><code class="plain"> </code><code class="color1">class</code><code class="plain">=</code><code class="string">"dsattr-manager dsvalidate-manager"</code><code class="plain">&gt;</code></div>
<div class="line"><code class="plain">&lt;/</code><code class="keyword">td</code><code class="plain">&gt;</code></div>
<div class="line"><code class="plain">&lt;/</code><code class="keyword">tr</code><code class="plain">&gt;</code></div>
<div class="line"><code class="plain">&lt;</code><code class="keyword">tr</code><code class="plain">&gt;</code></div>
<div class="line"><code class="plain">&lt;</code><code class="keyword">th</code><code class="plain">&gt;Country&lt;/</code><code class="keyword">th</code><code class="plain">&gt;</code></div>
<div class="line"><code class="plain">&lt;</code><code class="keyword">td</code><code class="plain"> </code><code class="color1">class</code><code class="plain">=</code><code class="string">"dsattr-country dsvalidate-country"</code><code class="plain">&gt;</code></div>
<div class="line"><code class="plain">&lt;/</code><code class="keyword">td</code><code class="plain">&gt;</code></div>
<div class="line"><code class="plain">&lt;/</code><code class="keyword">tr</code><code class="plain">&gt;</code></div>
<div class="line"><code class="plain">&lt;</code><code class="keyword">tr</code><code class="plain">&gt;</code></div>
<div class="line"><code class="plain">&lt;</code><code class="keyword">th</code><code class="plain">&gt;Address&lt;/</code><code class="keyword">th</code><code class="plain">&gt;</code></div>
<div class="line"><code class="plain">&lt;</code><code class="keyword">td</code><code class="plain"> </code><code class="color1">class</code><code class="plain">=</code><code class="string">"dsattr-address"</code><code class="plain">&gt;</code></div>
<div class="line"><code class="plain">&lt;</code><code class="keyword">ac</code><code class="plain">:placeholder&gt;Mailing address&lt;/</code><code class="keyword">ac</code><code class="plain">:placeholder&gt;</code></div>
<div class="line"><code class="plain">&lt;/</code><code class="keyword">td</code><code class="plain">&gt;</code></div>
<div class="line"><code class="plain">&lt;/</code><code class="keyword">tr</code><code class="plain">&gt;</code></div>
<div class="line"><code class="plain">&lt;/</code><code class="keyword">tbody</code><code class="plain">&gt;</code></div>
<div class="line"><code class="plain">&lt;/</code><code class="keyword">table</code><code class="plain">&gt;</code></div>
<div class="line"><code class="plain">...</code></div>
<div class="line"><code class="plain">&lt;/</code><code class="keyword">ac</code><code class="plain">:layout-section&gt;</code></div>
<div class="line"><code class="plain">&lt;/</code><code class="keyword">ac</code><code class="plain">:layout&gt;</code></div>
</div>
    </div>
<p   
>This is a standard Confluence blueprint markup with some notable modifications, namely &lt;TD&gt;-tag class attributes: <i class=" ">dsattr-manager</i>, <i class=" ">dsattr-country,</i> etc. These define JSON attributes (note the <i class=" ">data</i> object in the screenshot below):</p>
<p   
><img  class="confluence-embedded-image image-center"                 style="display:block; margin-left: auto; margin-right: auto;"
     src="images/wiki/download/attachments/51151335/Screenshot_2020-12-22_at_12.51.44.png" alt="images/wiki/download/attachments/51151335/Screenshot_2020-12-22_at_12.51.44.png"   />
To get the data published to my JIRA server I created a custom Confluence plugin that <a  class="external-link" href="https://github.com/mesilat/blueprint-validation-demo/blob/master/src/main/java/com/mesilat/bvp/demo/BaseEventListener.java">handles</a>     <span style="color: #24292e;">
<i class=" ">DataValidateEvent</i>. Let's take a closer look at the plugin's <i class=" ">dataObjectValidateEvent</i> method:    </span>
</p>
<p   
></p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="color1">@EventListener</code></div>
<div class="line"><code class="keyword">public</code><code class="plain"> </code><code class="keyword">void</code><code class="plain"> dataObjectValidateEvent(DataValidateEvent event) {</code></div>
<div class="line"><code class="plain">  </code><code class="keyword">if</code><code class="plain"> (!templateKey.equals(event.getTemplateKey())) {</code></div>
<div class="line"><code class="plain">    LOGGER.debug(String.format(</code><code class="string">"DataValidateEvent for template=%s; handler is %s, aborting"</code><code class="plain">, event.getTemplateKey(), templateKey));</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">return</code><code class="plain">;</code></div>
<div class="line"><code class="plain">  } </code><code class="keyword">else</code><code class="plain"> {</code></div>
<div class="line"><code class="plain">    LOGGER.debug(String.format(</code><code class="string">"DataValidateEvent for template=%s; processing..."</code><code class="plain">, event.getTemplateKey()));</code></div>
<div class="line"><code class="plain">  }</code></div>
</div>
    </div>
<p   
>First I need to make sure that Confluence page matches my blueprint. Blueprint Validation plugin publishes <i class=" ">DataValidateEvent</i> to all consumers without any filtering, so I implement this filtering myself.</p>
<p   
>The event object contains JSON data serialised to string, so I parse it and add some extra data for JIRA server:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">JsonNode node = mapper.readTree(event.getData());</code></div>
<div class="line"><code class="keyword">if</code><code class="plain"> (!node.isObject()) {</code></div>
<div class="line"><code class="plain">  </code><code class="keyword">throw</code><code class="plain"> </code><code class="keyword">new</code><code class="plain"> RuntimeException(</code><code class="string">"Unexpected data object"</code><code class="plain">);</code></div>
<div class="line"><code class="plain">}</code></div>
<div class="line"><code class="plain">ObjectNode obj = (ObjectNode)node;</code></div>
<div class="line"><code class="plain">obj.put(</code><code class="string">"id"</code><code class="plain">, page.getId());</code></div>
<div class="line"><code class="plain">obj.put(</code><code class="string">"title"</code><code class="plain">, page.getTitle());</code></div>
</div>
    </div>
<p   
>I use Atlassian     <span style="color: #24292e;">
<i class=" ">ApplicationLink</i> interface to communicate to JIRA:    </span>
</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">ApplicationLink jira = appLinkService.getPrimaryApplicationLink(JiraApplicationType.</code><code class="keyword">class</code><code class="plain">);</code></div>
<div class="line"><code class="keyword">if</code><code class="plain"> (jira == </code><code class="keyword">null</code><code class="plain">) {</code></div>
<div class="line"><code class="plain">  LOGGER.warn(</code><code class="string">"No JIRA application link configured"</code><code class="plain">);</code></div>
<div class="line"><code class="plain">  event.setValid(</code><code class="keyword">false</code><code class="plain">);</code></div>
<div class="line"><code class="plain">  event.addMessage(</code><code class="string">"No JIRA application link configured"</code><code class="plain">);</code></div>
<div class="line"><code class="plain">  </code><code class="keyword">return</code><code class="plain">;</code></div>
<div class="line"><code class="plain">}</code></div>
<div class="line"><code class="plain">...</code></div>
<div class="line"><code class="plain">ApplicationLinkRequestFactory reqFactory = jira.createAuthenticatedRequestFactory();</code></div>
<div class="line"><code class="plain">reqFactory</code></div>
<div class="line"><code class="plain">  .createRequest(Request.MethodType.POST, endpoint)</code></div>
<div class="line"><code class="plain">  .addHeader(</code><code class="string">"content-type"</code><code class="plain">, </code><code class="string">"application/json; charset=UTF-8"</code><code class="plain">)</code></div>
<div class="line"><code class="plain">  .setRequestBody(mapper.writerWithDefaultPrettyPrinter().writeValueAsString(obj))</code></div>
<div class="line"><code class="plain">  .executeAndReturn((com.atlassian.sal.api.net.Response response) -&gt; ...</code></div>
</div>
    </div>
<p   
>    <span style="color: #24292e;">
Finally, I need to guarantee that the data is actually received by JIRA. If any error happens the plugin must inform a user, so I wrap my code in try-catch...    </span>
</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="keyword">try</code><code class="plain"> {</code></div>
<div class="line"><code class="plain"> ...</code></div>
<div class="line"><code class="plain">} </code><code class="keyword">catch</code><code class="plain"> (Throwable ex) {</code></div>
<div class="line"><code class="plain">  event.setValid(</code><code class="keyword">false</code><code class="plain">);</code></div>
<div class="line"><code class="plain">  event.addMessage(</code><code class="string">"Failed to push changes to JIRA server: "</code><code class="plain"> + ex.getMessage());</code></div>
<div class="line"><code class="plain">  LOGGER.warn(</code><code class="string">"Failed to push changes to JIRA server"</code><code class="plain">, ex);</code></div>
<div class="line"><code class="plain">}</code></div>
</div>
    </div>
<p   
>    <span style="color: #24292e;">
...and deny page save if it cannot be published to JIRA:    </span>
</p>
<p   
>    <span style="color: #24292e;">
<img  class="confluence-embedded-image image-center"                 style="display:block; margin-left: auto; margin-right: auto;"
     src="images/wiki/download/attachments/51151335/Screenshot_2020-12-22_at_13.15.08.png" alt="images/wiki/download/attachments/51151335/Screenshot_2020-12-22_at_13.15.08.png"   />
    </span>
</p>
    </div>
    <div class="section section-1" id="src-51151335_UsingBlueprintValidationandConfluenceFieldsTogether-JIRAPart">
        <h1 class="heading "><span>JIRA Part</span></h1>
<p   
>On the JIRA server side I need to develop an <a  class="external-link" href="https://github.com/mesilat/blueprint-validation-demo-companion/blob/master/src/main/java/com/mesilat/cube/BaseResource.java">endpoint</a> that consumes the client data and stores it to a database table. I define the <a  class="external-link" href="https://github.com/mesilat/blueprint-validation-demo-companion/blob/master/src/main/java/com/mesilat/cube/company/Company.java">table</a> using Atlassian AO:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="color1">@Preload</code></div>
<div class="line"><code class="keyword">public</code><code class="plain"> </code><code class="keyword">interface</code><code class="plain"> Company </code><code class="keyword">extends</code><code class="plain"> RawEntity&lt;Long&gt; {</code></div>
<div class="line"><code class="plain">  </code><code class="keyword">public</code><code class="plain"> </code><code class="keyword">static</code><code class="plain"> String TABLE = </code><code class="string">"AO_2CAE32_COMPANY"</code><code class="plain">;</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">  </code><code class="color1">@NotNull</code></div>
<div class="line"><code class="plain">  </code><code class="color1">@PrimaryKey</code><code class="plain">(value = </code><code class="string">"ID"</code><code class="plain">)</code></div>
<div class="line"><code class="plain">  Long getID();</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">  </code><code class="color1">@StringLength</code><code class="plain">(</code><code class="value">255</code><code class="plain">)</code></div>
<div class="line"><code class="plain">  String getTitle();</code></div>
<div class="line"><code class="plain">  </code><code class="keyword">void</code><code class="plain"> setTitle(String title);</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">  </code><code class="color1">@Indexed</code></div>
<div class="line"><code class="plain">  </code><code class="color1">@StringLength</code><code class="plain">(</code><code class="value">255</code><code class="plain">)</code></div>
<div class="line"><code class="plain">  String getManager();</code></div>
<div class="line"><code class="plain">  </code><code class="keyword">void</code><code class="plain"> setManager(String category);</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">  </code><code class="color1">@Indexed</code></div>
<div class="line"><code class="plain">  </code><code class="color1">@StringLength</code><code class="plain">(</code><code class="value">2</code><code class="plain">)</code></div>
<div class="line"><code class="plain">  String getCountry();</code></div>
<div class="line"><code class="plain">  </code><code class="keyword">void</code><code class="plain"> setCountry(String country);</code></div>
<div class="line"><code class="plain">}</code></div>
</div>
    </div>
<p   
>The <a  class="external-link" href="https://github.com/mesilat/blueprint-validation-demo-companion/blob/master/src/main/java/com/mesilat/cube/company/CompanyServiceImpl.java">save</a> method is very simple:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="color1">@Override</code></div>
<div class="line"><code class="keyword">public</code><code class="plain"> </code><code class="keyword">void</code><code class="plain"> save(ObjectNode company) {</code></div>
<div class="line"><code class="plain">  ao.executeInTransaction(() -&gt; {</code></div>
<div class="line"><code class="plain">    Long id = Util.getLong(company, </code><code class="string">"id"</code><code class="plain">);</code></div>
<div class="line"><code class="plain">    Company c = ao.get(Company.</code><code class="keyword">class</code><code class="plain">, id);</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">if</code><code class="plain"> (c == </code><code class="keyword">null</code><code class="plain">) {</code></div>
<div class="line"><code class="plain">      c = ao.create(Company.</code><code class="keyword">class</code><code class="plain">, </code><code class="keyword">new</code><code class="plain"> DBParam(</code><code class="string">"ID"</code><code class="plain">, id));</code></div>
<div class="line"><code class="plain">    }</code></div>
<div class="line"><code class="plain">    c.setTitle(Util.getText(company, </code><code class="string">"title"</code><code class="plain">));</code></div>
<div class="line"><code class="plain">    c.setCountry(Util.getText(company, </code><code class="string">"country"</code><code class="plain">));</code></div>
<div class="line"><code class="plain">    c.setManager(Util.getText(company, </code><code class="string">"manager"</code><code class="plain">, </code><code class="string">"fullName"</code><code class="plain">));</code></div>
<div class="line"><code class="plain">    c.save();</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">return</code><code class="plain"> </code><code class="keyword">null</code><code class="plain">;</code></div>
<div class="line"><code class="plain">  });</code></div>
<div class="line"><code class="plain">}</code></div>
</div>
    </div>
<p   
>I built and deployed the plugin to my JIRA server then tested to make sure that the Company table is actually populated. As Atlassian AO adds some prefixes to custom tables, take a note of the actual name of the Company table &ndash; in case of <a  class="external-link" href="https://github.com/mesilat/blueprint-validation-demo-companion">blueprint-validation-demo-companion</a> plugin it is called <i class=" ">AO_2CAE32_COMPANY</i>.</p>
<p   
>Now that data is piped from Confluence to JIRA let's get to Mondrian schema.</p>
    </div>
    <div class="section section-1" id="src-51151335_UsingBlueprintValidationandConfluenceFieldsTogether-MondrianPart">
        <h1 class="heading "><span>Mondrian Part</span></h1>
<p   
><a   href="44696004.html">Confluence Fields</a> plugin uses Mondrian v4 schema format. You can download the default schema file as <a   href="https://slava.bvn.me/wiki/display/MES/Using+Mondrian+with+Confluence+Fields">described</a> in the documentation and use it as a sample.</p>
<p   
>Make sure that WORKLOG query contains required Confluence custom fields. My JIRA's <i class=" ">Clients</i> custom field is <i class=" ">cf_11100</i> so the query definition looks as follows:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">&lt;</code><code class="keyword">Query</code><code class="plain"> </code><code class="color1">alias</code><code class="plain">=</code><code class="string">"WORKLOG"</code><code class="plain">&gt;</code></div>
<div class="line"><code class="plain">&lt;</code><code class="keyword">ExpressionView</code><code class="plain">&gt;</code></div>
<div class="line"><code class="plain">&lt;</code><code class="keyword">SQL</code><code class="plain"> </code><code class="color1">dialect</code><code class="plain">=</code><code class="string">"postgresql"</code><code class="plain">&gt;</code><code class="color2">&lt;![CDATA[SELECT</code></div>
<div class="line"><code class="color2">jiraissue.ID,</code></div>
<div class="line"><code class="color2">concat(project.pkey, '-', jiraissue.issuenum) as ISSUEKEY,</code></div>
<div class="line"><code class="color2">jiraissue.PROJECT as PROJECTID,</code></div>
<div class="line"><code class="color2">COALESCE(jiraissue.issuetype, '-1') as TYPEID,</code></div>
<div class="line"><code class="color2">app_user.lower_user_name as AUTHOR,</code></div>
<div class="line"><code class="color2">DATE(worklog.CREATED) as CREATED,</code></div>
<div class="line"><code class="color2">DATE(worklog.STARTDATE) as STARTED,</code></div>
<div class="line"><code class="color2">cube."TIME_WORKED" / 3600 as TIMEWORKED,</code></div>
<div class="line"><code class="color2">cube.cf_11100_id</code></div>
<div class="line"><code class="color2">FROM</code></div>
<div class="line"><code class="color2">jiraissue</code></div>
<div class="line"><code class="color2">INNER JOIN project ON jiraissue.PROJECT = project.ID</code></div>
<div class="line"><code class="color2">INNER JOIN worklog ON jiraissue.ID = worklog.issueid</code></div>
<div class="line"><code class="color2">INNER JOIN "AO_9417FD_WORKLOG_CUBE" cube ON jiraissue.ID = cube."ISSUE_ID" and worklog.id = cube."LOG_ID"</code></div>
<div class="line"><code class="color2">INNER JOIN app_user ON app_user.user_key = worklog.author]]&gt;</code><code class="plain">&lt;/</code><code class="keyword">SQL</code><code class="plain">&gt;</code></div>
<div class="line"><code class="plain">&lt;/</code><code class="keyword">ExpressionView</code><code class="plain">&gt;</code></div>
<div class="line"><code class="plain">&lt;/</code><code class="keyword">Query</code><code class="plain">&gt;</code></div>
</div>
    </div>
<p   
>I defined CLIENTS query and made sure it contains all data needed (including the Country column):</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">&lt;</code><code class="keyword">Query</code><code class="plain"> </code><code class="color1">alias</code><code class="plain">=</code><code class="string">"CLIENTS"</code><code class="plain"> </code><code class="color1">keyColumn</code><code class="plain">=</code><code class="string">"id"</code><code class="plain">&gt;</code></div>
<div class="line"><code class="plain">&lt;</code><code class="keyword">ExpressionView</code><code class="plain">&gt;</code></div>
<div class="line"><code class="plain">&lt;</code><code class="keyword">SQL</code><code class="plain"> </code><code class="color1">dialect</code><code class="plain">=</code><code class="string">"postgresql"</code><code class="plain">&gt;</code><code class="color2">&lt;![CDATA[SELECT</code></div>
<div class="line"><code class="color2">  "ID" as id,</code></div>
<div class="line"><code class="color2">  "TITLE" as title,</code></div>
<div class="line"><code class="color2">  "COUNTRY" as country</code></div>
<div class="line"><code class="color2">  FROM "AO_2CAE32_COMPANY"]]&gt;</code><code class="plain">&lt;/</code><code class="keyword">SQL</code><code class="plain">&gt;</code></div>
<div class="line"><code class="plain">&lt;/</code><code class="keyword">ExpressionView</code><code class="plain">&gt;</code></div>
<div class="line"><code class="plain">&lt;/</code><code class="keyword">Query</code><code class="plain">&gt;</code></div>
</div>
    </div>
<p   
>The matching dimension has the Country column in a hierarchy:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">&lt;</code><code class="keyword">Dimension</code><code class="plain"> </code><code class="color1">name</code><code class="plain">=</code><code class="string">"Clients"</code><code class="plain"> </code><code class="color1">table</code><code class="plain">=</code><code class="string">"CLIENTS"</code><code class="plain"> </code><code class="color1">key</code><code class="plain">=</code><code class="string">"Client"</code><code class="plain">&gt;</code></div>
<div class="line"><code class="plain">&lt;</code><code class="keyword">Attributes</code><code class="plain">&gt;</code></div>
<div class="line"><code class="plain">  &lt;</code><code class="keyword">Attribute</code><code class="plain"> </code><code class="color1">name</code><code class="plain">=</code><code class="string">"Client"</code><code class="plain"> </code><code class="color1">keyColumn</code><code class="plain">=</code><code class="string">"id"</code><code class="plain"> </code><code class="color1">nameColumn</code><code class="plain">=</code><code class="string">"title"</code><code class="plain"> </code><code class="color1">hasHierarchy</code><code class="plain">=</code><code class="string">"false"</code><code class="plain"> /&gt;</code></div>
<div class="line"><code class="plain">  &lt;</code><code class="keyword">Attribute</code><code class="plain"> </code><code class="color1">name</code><code class="plain">=</code><code class="string">"Country"</code><code class="plain"> </code><code class="color1">keyColumn</code><code class="plain">=</code><code class="string">"country"</code><code class="plain"> </code><code class="color1">hasHierarchy</code><code class="plain">=</code><code class="string">"false"</code><code class="plain"> /&gt;</code></div>
<div class="line"><code class="plain">&lt;/</code><code class="keyword">Attributes</code><code class="plain">&gt;</code></div>
<div class="line"><code class="plain">&lt;</code><code class="keyword">Hierarchies</code><code class="plain">&gt;</code></div>
<div class="line"><code class="plain">  &lt;</code><code class="keyword">Hierarchy</code><code class="plain"> </code><code class="color1">name</code><code class="plain">=</code><code class="string">"Client"</code><code class="plain"> </code><code class="color1">allMemberName</code><code class="plain">=</code><code class="string">"All Clients"</code><code class="plain">&gt;</code></div>
<div class="line"><code class="plain">    &lt;</code><code class="keyword">Level</code><code class="plain"> </code><code class="color1">attribute</code><code class="plain">=</code><code class="string">"Client"</code><code class="plain"> /&gt;</code></div>
<div class="line"><code class="plain">  &lt;/</code><code class="keyword">Hierarchy</code><code class="plain">&gt;</code></div>
<div class="line"><code class="plain">  &lt;</code><code class="keyword">Hierarchy</code><code class="plain"> name="Country &gt; Client" allMemberName="All Clients"&gt;</code></div>
<div class="line"><code class="plain">    &lt;</code><code class="keyword">Level</code><code class="plain"> </code><code class="color1">attribute</code><code class="plain">=</code><code class="string">"Country"</code><code class="plain"> /&gt;</code></div>
<div class="line"><code class="plain">    &lt;</code><code class="keyword">Level</code><code class="plain"> </code><code class="color1">attribute</code><code class="plain">=</code><code class="string">"Client"</code><code class="plain"> /&gt;</code></div>
<div class="line"><code class="plain">  &lt;/</code><code class="keyword">Hierarchy</code><code class="plain">&gt;</code></div>
<div class="line"><code class="plain">&lt;/</code><code class="keyword">Hierarchies</code><code class="plain">&gt;</code></div>
<div class="line"><code class="plain">&lt;/</code><code class="keyword">Dimension</code><code class="plain">&gt;</code></div>
</div>
    </div>
<p   
>Finally I reference Clients dimension in a <i class=" ">Worklog</i> cube:</p>
    <div  class="confbox programlisting" style="counter-reset: scroll-code-numbering 1">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-linenumbers="false" data-firstline="1">
<div class="line"><code class="plain">&lt;</code><code class="keyword">Cube</code><code class="plain"> </code><code class="color1">name</code><code class="plain">=</code><code class="string">"Worklog"</code><code class="plain">&gt;</code></div>
<div class="line"><code class="plain">&lt;</code><code class="keyword">Dimensions</code><code class="plain">&gt;</code></div>
<div class="line"><code class="plain">&lt;</code><code class="keyword">Dimension</code><code class="plain"> </code><code class="color1">source</code><code class="plain">=</code><code class="string">"Issue"</code><code class="plain"> /&gt;</code></div>
<div class="line"><code class="plain">&lt;</code><code class="keyword">Dimension</code><code class="plain"> </code><code class="color1">source</code><code class="plain">=</code><code class="string">"Project"</code><code class="plain"> /&gt;</code></div>
<div class="line"><code class="plain">&lt;</code><code class="keyword">Dimension</code><code class="plain"> </code><code class="color1">source</code><code class="plain">=</code><code class="string">"Type"</code><code class="plain"> /&gt;</code></div>
<div class="line"><code class="plain">&lt;</code><code class="keyword">Dimension</code><code class="plain"> </code><code class="color1">source</code><code class="plain">=</code><code class="string">"User"</code><code class="plain"> </code><code class="color1">name</code><code class="plain">=</code><code class="string">"Worker"</code><code class="plain"> /&gt;</code></div>
<div class="line"><code class="plain">&lt;</code><code class="keyword">Dimension</code><code class="plain"> </code><code class="color1">source</code><code class="plain">=</code><code class="string">"LogDate"</code><code class="plain"> </code><code class="color1">name</code><code class="plain">=</code><code class="string">"Created"</code><code class="plain"> /&gt;</code></div>
<div class="line"><code class="plain">&lt;</code><code class="keyword">Dimension</code><code class="plain"> </code><code class="color1">source</code><code class="plain">=</code><code class="string">"LogDate"</code><code class="plain"> </code><code class="color1">name</code><code class="plain">=</code><code class="string">"Start"</code><code class="plain"> /&gt;</code></div>
<div class="line"><code class="plain">&lt;</code><code class="keyword">Dimension</code><code class="plain"> </code><code class="color1">source</code><code class="plain">=</code><code class="string">"Clients"</code><code class="plain"> /&gt;</code></div>
<div class="line"><code class="plain">&lt;</code><code class="keyword">Dimension</code><code class="plain"> </code><code class="color1">source</code><code class="plain">=</code><code class="string">"Contracts"</code><code class="plain"> /&gt;</code></div>
<div class="line"><code class="plain">&lt;</code><code class="keyword">Dimension</code><code class="plain"> </code><code class="color1">source</code><code class="plain">=</code><code class="string">"Products"</code><code class="plain"> /&gt;</code></div>
<div class="line"><code class="plain">&lt;/</code><code class="keyword">Dimensions</code><code class="plain">&gt;</code></div>
<div class="line"><code class="plain">&lt;</code><code class="keyword">MeasureGroups</code><code class="plain">&gt;</code></div>
<div class="line"><code class="plain">&lt;</code><code class="keyword">MeasureGroup</code><code class="plain"> </code><code class="color1">table</code><code class="plain">=</code><code class="string">"WORKLOG"</code><code class="plain">&gt;</code></div>
<div class="line"><code class="plain">&lt;</code><code class="keyword">Measures</code><code class="plain">&gt;</code></div>
<div class="line"><code class="plain">&lt;</code><code class="keyword">Measure</code><code class="plain"> </code><code class="color1">aggregator</code><code class="plain">=</code><code class="string">"count"</code><code class="plain"> </code><code class="color1">column</code><code class="plain">=</code><code class="string">"id"</code><code class="plain"> </code><code class="color1">name</code><code class="plain">=</code><code class="string">"Worklogs count"</code><code class="plain"> /&gt;</code></div>
<div class="line"><code class="plain">&lt;</code><code class="keyword">Measure</code><code class="plain"> </code><code class="color1">aggregator</code><code class="plain">=</code><code class="string">"sum"</code><code class="plain"> </code><code class="color1">column</code><code class="plain">=</code><code class="string">"timeworked"</code><code class="plain"> </code><code class="color1">name</code><code class="plain">=</code><code class="string">"Time Spent"</code><code class="plain"> /&gt;</code></div>
<div class="line"><code class="plain">&lt;/</code><code class="keyword">Measures</code><code class="plain">&gt;</code></div>
<div class="line"><code class="plain">&lt;</code><code class="keyword">DimensionLinks</code><code class="plain">&gt;</code></div>
<div class="line"><code class="plain">&lt;</code><code class="keyword">ForeignKeyLink</code><code class="plain"> </code><code class="color1">dimension</code><code class="plain">=</code><code class="string">"Issue"</code><code class="plain"> </code><code class="color1">foreignKeyColumn</code><code class="plain">=</code><code class="string">"id"</code><code class="plain"> /&gt;</code></div>
<div class="line"><code class="plain">&lt;</code><code class="keyword">ForeignKeyLink</code><code class="plain"> </code><code class="color1">dimension</code><code class="plain">=</code><code class="string">"Project"</code><code class="plain"> </code><code class="color1">foreignKeyColumn</code><code class="plain">=</code><code class="string">"projectid"</code><code class="plain"> /&gt;</code></div>
<div class="line"><code class="plain">&lt;</code><code class="keyword">ForeignKeyLink</code><code class="plain"> </code><code class="color1">dimension</code><code class="plain">=</code><code class="string">"Type"</code><code class="plain"> </code><code class="color1">foreignKeyColumn</code><code class="plain">=</code><code class="string">"typeid"</code><code class="plain"> /&gt;</code></div>
<div class="line"><code class="plain">&lt;</code><code class="keyword">ForeignKeyLink</code><code class="plain"> </code><code class="color1">dimension</code><code class="plain">=</code><code class="string">"Worker"</code><code class="plain"> </code><code class="color1">foreignKeyColumn</code><code class="plain">=</code><code class="string">"author"</code><code class="plain"> /&gt;</code></div>
<div class="line"><code class="plain">&lt;</code><code class="keyword">ForeignKeyLink</code><code class="plain"> </code><code class="color1">dimension</code><code class="plain">=</code><code class="string">"Created"</code><code class="plain"> </code><code class="color1">foreignKeyColumn</code><code class="plain">=</code><code class="string">"created"</code><code class="plain"> /&gt;</code></div>
<div class="line"><code class="plain">&lt;</code><code class="keyword">ForeignKeyLink</code><code class="plain"> </code><code class="color1">dimension</code><code class="plain">=</code><code class="string">"Start"</code><code class="plain"> </code><code class="color1">foreignKeyColumn</code><code class="plain">=</code><code class="string">"started"</code><code class="plain"> /&gt;</code></div>
<div class="line"><code class="plain">&lt;</code><code class="keyword">ForeignKeyLink</code><code class="plain"> </code><code class="color1">dimension</code><code class="plain">=</code><code class="string">"Clients"</code><code class="plain"> </code><code class="color1">foreignKeyColumn</code><code class="plain">=</code><code class="string">"cf_11100_id"</code><code class="plain"> /&gt;</code></div>
<div class="line"><code class="plain">&lt;/</code><code class="keyword">DimensionLinks</code><code class="plain">&gt;</code></div>
<div class="line"><code class="plain">&lt;/</code><code class="keyword">MeasureGroup</code><code class="plain">&gt;</code></div>
<div class="line"><code class="plain">&lt;/</code><code class="keyword">MeasureGroups</code><code class="plain">&gt;</code></div>
<div class="line"><code class="plain">&lt;/</code><code class="keyword">Cube</code><code class="plain">&gt;</code></div>
</div>
    </div>
<p   
>To test this <a  class="external-link" href="https://github.com/mesilat/blueprint-validation-demo-companion/blob/master/default.xml">schema</a> install Tomcat and get your external Mondrian server running as described in the <a   href="https://slava.bvn.me/wiki/display/MES/Using+Mondrian+with+Confluence+Fields">documentation</a>, then use Excel to do your JIRA OLAP.</p>
<p   
>The demo projects referenced in this blog have other templates defined, namely Contracts and Products. Feel free to extend the projects to your needs, you can create very complex JIRA reports using the technics described above.</p>
<p   
>There is a DEMO Mondrian server that you can connect to test JIRA OLAP in live:</p>
    <div  class="tablewrap">
        <table class="confluenceTable">
                    <colgroup>
                                    <col />
                                    <col />
                            </colgroup>
        <thead class=" "></thead><tfoot class=" "></tfoot><tbody class=" ">    <tr>
            <td  class="confluenceTh" rowspan="1" colspan="1">
    <p   
>Endpoint</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
><a  class="external-link" href="https://demo.mesilat.com/mondrian/xmla">https://demo.mesilat.com/mondrian/xmla</a></p>
            </td>
        </tr>
    <tr>
            <td  class="confluenceTh" rowspan="1" colspan="1">
    <p   
>Username</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>xmla</p>
            </td>
        </tr>
    <tr>
            <td  class="confluenceTh" rowspan="1" colspan="1">
    <p   
>Password</p>
            </td>
                <td  class="confluenceTd" rowspan="1" colspan="1">
    <p   
>xmlaxmla</p>
            </td>
        </tr>
</tbody>        </table>
            </div>
    </div>
        </div>

    </article>


            <nav id="ht-post-nav">
                <a href="44696045.html" class="ht-post-nav-prev">
            <svg width="22px" height="22px" viewBox="0 0 22 22" version="1.1" xmlns="http://www.w3.org/2000/svg"
                 xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:sketch="http://www.bohemiancoding.com/sketch/ns">
                <g id="ht-icon-prev" sketch:type="MSArtboardGroup">
                    <path fill="#000000" d="M16,8 L16,6 L6,6 L6,16 L8,16 L8,8 L16,8 Z" id="Rectangle-2"
                          sketch:type="MSShapeGroup"
                          transform="translate(11.000000, 11.000000) rotate(-45.000000) translate(-11.000000, -11.000000) "></path>
                </g>
            </svg>
            <span>Privacy and Security Statement</span>
        </a>
        </nav>    
            
    <footer id="ht-footer">
    <a href="#" id="ht-jump-top" class="sp-aui-icon-small sp-aui-iconfont-arrows-up"></a>
</footer></div>

<div>
    <div id="ht-mq-detect"></div>
</div>

    <script src="js/lunr.js"></script>
    <script src="js/lunr-extras.js"></script>
    <script src="assets/js/scroll-search.js"></script>

    <script src="assets/js/expand-macro.js"></script>
</body>
</html>
